       
template:
  - sensor:

      # ---------------------------------------------------------
      # 1) หา media_player ตัวที่ active ล่าสุด (playing/paused)
      # ---------------------------------------------------------
      - name: Last Active Media Player
        unique_id: last_active_media_player_t620
        state: >-
          {% set players = states.media_player
              | selectattr('state', 'in', ['playing', 'paused'])
              | sort(reverse=true, attribute='last_changed')
              | list %}
          {% if players | count > 0 %}
            {{ players[0].entity_id }}
          {% else %}
            none
          {% endif %}


      # ---------------------------------------------------------
      # 2) เก็บ artwork สุดท้าย ถ้าไม่มี player เล่นอยู่
      # ---------------------------------------------------------
      - name: Last Album Art
        unique_id: last_album_art_memory
        state: >-
          {% set p = states('sensor.last_active_media_player') %}
          {% set art = state_attr(p, 'entity_picture') %}
          
          {% if p != 'none' and art not in [none, '', 'unknown'] %}
            {{ art }}
          {% else %}
            {{ this.state }}
          {% endif %}
          

